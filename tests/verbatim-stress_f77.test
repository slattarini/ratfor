#!/bin/sh

# Stress test for ratfor (by compiling and running generated fortran code)

. ./defs.sh || exit 99

require_fortran_compiler

cat > tst.r <<EOF
program VerbatimStress
    implicit none
    integer i, j, sum, realsum, fakesum, lastsum
    sum = 0
    define sum fakesum
    define PRINT write
    realsum = 0
    fakesum = -1000
for(i = 0; i <= 1; i = i + 1) {
# six leading spaces here
%      do 10 j = 1, 3
%         sum = sum + i * 10 + j
%10    continue
    }
# six leading spaces here
%      lastsum = sum
    PRINT(*, 100) lastsum; 100 format(I10)
end # VerbatimStress
EOF

cat tst.r


run_CMD "$RATFOR" tst.r || testcase_FAIL
mv stdout tst.f

run_F77 -- -o tst.exe tst.f || testcase_FAIL
run_CMD ./tst.exe || testcase_FAIL
test -s stderr && testcase_FAIL

expected_answer=42
got_answer=`cat stdout | ws_normalize`
test x"$got_answer" = x"$expected_answer" || testcase_FAIL

testcase_PASS

# vim: ft=sh ts=4 sw=4 et

#!/bin/sh

# Stress test for ratfor w.r.t. the stacking of loops (checks done by
# compiling and running generated fortran code).

. ./defs.sh || exit 99

require_strong_fortran_compiler

loophead="\
if (y == 1) {
  repeat { 
    x = x + 1
    while (x < 5) {
      write(*,500)x
      x = x + 1"

looptail="\
    } # while
  } until (x >= 3); # repeat
} # if"

$AWK </dev/null >tst.r -v loophead="$loophead" -v looptail="$looptail" '
BEGIN {
    print "program stmtstackstress"
    print "implicit none"
    print "integer x, y"
    print "500 format(I1)"
    print "600 format('\''~~~'\'')"
    print ""
    print ""
    print "write(*,600)"
    
    print "x = 1"
    for(i = 1; i <= 50; i++)
        print "while(x < 8)"
    print "{ write(*,500)x; goto 100 }"
    
    print ""
    print "100 continue"
    print "write(*,600)"
    print ""
    
    N = 150
    print "y = 1"
    print "x = 1"
    for (i = 1; i <= N; i++)
        print loophead
    for (i = 1; i <= N; i++)
        print looptail
    
    print ""
    print "write(*,600)"
    print ""
    print "stop"
    print "end"
}' 

cat > exp <<EOF
~~~
1
~~~
2
4
~~~
EOF

cat tst.r

run_CMD "$RATFOR" tst.r || testcase_FAIL
mv stdout tst.f

run_CMD $F77 -o tst.exe tst.f || testcase_FAIL
timer 20 run_CMD ./tst.exe || testcase_FAIL
mv stdout got

cat exp
cat got

test -s stderr && testcase_FAIL

$DIFF_U exp got || testcase_FAIL

testcase_PASS

# vim: ft=sh ts=4 sw=4 et

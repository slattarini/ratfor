#!/bin/sh

# Check that ratfor works on very long input files (process, compile & run)

. ./defs.sh || exit 99

require_fortran_compiler

# a bigger number will slow down too much the fortran compiler
startlab=6000

# NOTE: *six* leading spaces here - they are necessary!
$SED 's/^/      /' >sanity.f <<EOF
program sanity
  stop
end
EOF
$F77 sanity.f -o sanity.exe 2>sanity.err
$GREP "MAIN sanity:" sanity.err && \
  testcase_SKIP "fort77 is too much limited to be used in this test case"
rm -f sanity.*

cat > tst.r <<EOF
program longprog
implicit none
integer x, y, t
5 format("n:", I10, "|", "x:", I10, "|", "y:" I10)
EOF

$AWK </dev/null >>tst.r "
  BEGIN {
    for (i = 10; i < $startlab; i = i + 1) {
      print i, \"continue\";
      print \"x = \", i, \"+ 1\";
      print \"y = \", i, \"* 2\";
      print \"write(*,5)\", i, \", x, y\"
      if (i + 2 < $startlab)
        print \"goto\", i+2;
      else
        print \"stop\"
    }
  }
"

echo 'end' >>tst.r

$AWK </dev/null >>exp-t "BEGIN {
    for (i = 10; i < $startlab; i = i + 2) {
        print \"n:\", i, \"|\", \"x:\", i+1, \"|\", \"y:\", (i*2)
    }
}"

run_RATFOR -e 0 -- -l $startlab tst.r || testcase_FAIL
mv stdout tst.f

run_F77 -e 0 -- -o tst.exe tst.f || testcase_FAIL

run_CMD ./tst.exe -e 0 || testcase_FAIL
test -s stderr && testcase_FAIL

edit="\$SED -e 's/ *: *//g' -e 's/ *| */ | /g'"
ws_normalize <stdout | eval "$edit" >got
ws_normalize <exp-t | eval "$edit" >exp

$DIFF_U exp got || testcase_FAIL

testcase_PASS

# vim: ft=sh ts=4 sw=4 et

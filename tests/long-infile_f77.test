#!/bin/sh

# Check that ratfor works on very long input files (process, compile & run)

. ../lib/rat4-t.sh || exit 99

require_strong_fortran_compiler

# a bigger number will slow down too much the fortran compiler
startlab=6000

cat > tst.r <<EOF
program longprog
implicit none
integer x, y, t
5 format("n:", I10, "|", "x:", I10, "|", "y:" I10)
EOF

$AWK </dev/null >>tst.r "
  BEGIN {
    for (i = 10; i < $startlab; i = i + 1) {
      print i, \"continue\";
      print \"x = \", i, \"+ 1\";
      print \"y = \", i, \"* 2\";
      print \"write(*,5)\", i, \", x, y\"
      if (i + 2 < $startlab)
        print \"goto\", i+2;
      else
        print \"call halt\"
    }
  }
"

echo 'end' >>tst.r

$AWK </dev/null >>exp-t "BEGIN {
    for (i = 10; i < $startlab; i = i + 2) {
        print \"n:\", i, \"|\", \"x:\", i+1, \"|\", \"y:\", (i*2)
    }
}"

# Ratfor might require quite a long time to process such a large file,
# so be sure to leave it some times (say 3 minutes) before considering
# it timed out (default with run_RATFOR would be 5 or 10 seconds).
run_RATFOR -t 180 -- -l $startlab tst.r || testcase_FAIL
mv stdout tst.f

run_F77 tst.f || testcase_FAIL

run_command ./tst.exe || testcase_FAIL
test -s stderr && testcase_FAIL

edit="\$SED -e 's/ *: *//g' -e 's/ *| */ | /g'"
ws_normalize <stdout | eval "$edit" >got
ws_normalize <exp-t | eval "$edit" >exp

# Avoid to `cat' again exp and got, as they might be huge.
$DIFF_U exp got || testcase_FAIL

testcase_DONE

# vim: ft=sh ts=4 sw=4 et

#!/bin/sh

# Testsuite sanity check: check the `run_command' subroutine.

. ./TestsAux/defs.sh || exit 99

NL='
'

cwd=`pwd` || testcase_HARDERROR

test_cleanup() {
    rm -f stdout stderr stdall
}

PATH=$cwd:$PATH
export PATH

sed 's/^ *//' >test_script <<'EOF'
    #!/bin/sh
    echo "OUT${1-}"
    echo "ERR${1-}" >&2
    exit ${2-0}
EOF
chmod a+x test_script

test_cleanup
run_command test_script 1 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT1" || testcase_FAIL
test x"`cat stderr`" = x"ERR1" || testcase_FAIL

test_cleanup
run_command ./test_script 2 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT2" || testcase_FAIL
test x"`cat stderr`" = x"ERR2" || testcase_FAIL

test_cleanup
run_command "$cwd"/test_script 3 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT3" || testcase_FAIL
test x"`cat stderr`" = x"ERR3" || testcase_FAIL

test_cleanup
run_command -e 0 test_script 4 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT4" || testcase_FAIL
test x"`cat stderr`" = x"ERR4" || testcase_FAIL

test_cleanup
run_command -m test_script 5 || testcase_FAIL
test -f stdout && testcase_FAIL
test -f stderr && testcase_FAIL
test -f stdall || testcase_FAIL
test x"`tr '\012' '@' <stdall`" = x"OUT5@ERR5@" || testcase_FAIL

test_cleanup
run_command -e 15 test_script 6 15 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT6" || testcase_FAIL
test x"`cat stderr`" = x"ERR6" || testcase_FAIL

test_cleanup
run_command -e FAIL test_script 7 3 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT7" || testcase_FAIL
test x"`cat stderr`" = x"ERR7" || testcase_FAIL

test_cleanup
run_command -e IGNORE test_script 8 0 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT8" || testcase_FAIL
test x"`cat stderr`" = x"ERR8" || testcase_FAIL

test_cleanup
run_command -e IGNORE test_script 9 1 || testcase_FAIL
test -f stdout || testcase_FAIL
test -f stderr || testcase_FAIL
test -f stdall && testcase_FAIL
test x"`cat stdout`" = x"OUT9" || testcase_FAIL
test x"`cat stderr`" = x"ERR9" || testcase_FAIL


test_cleanup
testcase_PASS

# vim: ft=sh ts=4 sw=4 et

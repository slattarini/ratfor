#!/bin/sh

# Stress test for ratfor (interactions between `%' and `define'/`include')

. ./TestsAux/defs.sh || exit 99

cat > tst.r <<EOF
define PERCENT1 %
% && a1
define(PERCENT2,%)
% && a2
PERCENT1 && b1
PERCENT2 && b2
define mu1  % && c1
define(mu2, % && c2)
mu1
mu2
mu1 mu2
define FOO 1 % && x1
define(BAR,1);% && x2
include inc.r; zap;
EOF

cat > inc.r <<EOF
% || inc
EOF

cat tst.r
cat inc.r

run_command "$RATFOR" tst.r || testcase_FAIL
test -s stderr && testcase_FAIL
for x in a b c; do
  for i in 1 2; do
    $FGREP "&& $x$i" stdout || testcase_FAIL
    $FGREP ".and. $x$i" stdout && testcase_FAIL
  done
done
$FGREP "&& c1 mu2" stdout || testcase_FAIL
$FGREP "|| inc" stdout || testcase_FAIL
$FGREP ".or. inc" stdout && testcase_FAIL

testcase_PASS

# vim: ft=sh ts=4 sw=4 et

#!/bin/sh

# Check the the `define' builtin deal gracefully with long macro defs.
# This testcase is a bit hackish.

. ./TestsAux/test-lib.sh || exit 99

s=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
s1=$s$s$s$s$s$s$s$s
s2="\
$s
$s$s
$s$s$s
$s$s$s$s
$s$s$s$s$s + $s$s$s$s"

cat >tst.r <<EOF
define a1 $s1
define(a2, {
$s2
})
a1
a2
EOF

cat >exp <<EOF
$s1
$s2
EOF

cat tst.r

run_RATFOR tst.r || testcase_FAIL
test -s stderr && testcase_FAIL

# sigh! we have to account for line continuations introduced by fortran
$AWK '
    BEGIN {
        s = ""
        sprn = 0
    }
    /^[cC]/{
        next
    }
    /^      / {
        if (sprn)
            print s
        sprn = 1;
        sub("^      ", "")
        s = $0
        next;
    }
    /^     [^ ]/{
        sub("^     [^ ]", "")
        s = s $0
        next
    }
    END {
        if (sprn)
            print s
    }
' <stdout >got

cat exp
cat got

$DIFF_U exp got || testcase_FAIL

testcase_PASS

# vim: ft=sh ts=4 sw=4 et
